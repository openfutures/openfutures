<?php
/**
 * @file
 * Code for the Library Scenario feature.
 */

include_once 'library_scenario.features.inc';

define('DISCOVER_SCENARIOS_TEXT_FORM', 'views-exposed-form-browse-scenarios-discover-mode-list');

/**
 * Implement hook_form_FORM_ID_alter(&$form, &$form_state, $form_id)
 */
function library_scenario_form_scenario_node_form_alter(&$form, &$form_state, $form_id) {
  // Add some JS for progressive enhancement
  // $form['#attached']['js'] = array(
  //   drupal_get_path('module', 'library_scenario') . '/library_scenario.js',
  // );

  // Make some changes to the scenario location fields
  $language = $form['field_scenario_location']['#language'];
  unset($form['field_scenario_location'][$language]['#title']);
  unset($form['field_scenario_location'][$language]['#description']); // unsetting this here for cosmetic purposes instead of removing it from the field configuration.

  // Add a default value for location if there isn't an existing value
  $form['field_scenario_location'][$language]['#attributes']['placeholder'] = t('Enter place names separated by a comma...');
  $form['field_scenario_location']['#prefix'] = '<p class="form-field-prefix">Add place names or geographic areas that represents the spatial coverage of the scenario. Select global context for scenarios that do not have specific geographic reference.</p>';

  // Redirect back to node add form to streamline content authoring experience.
  $form['actions']['submit']['#submit'][] = '_library_scenario_submit';
}

/**
 * Implement hook_form_FORM_ID_alter(&$form, &$form_state, $form_id)
 */
function library_scenario_form_views_exposed_form_alter(&$form, &$form_state, $form_id) {
  // Changes to search/filter form for Browse Scenarios view.
  if ($form['#id'] == DISCOVER_SCENARIOS_TEXT_FORM) {
    $form['keys']['#attributes']['placeholder'] = t('Enter terms...');
    $keys_filter_submit = $form['submit'];
    $keys_filter_submit['#id'] = 'edit-submit-browse-scenarios2';
    $keys_filter_submit['#value'] = t('Search');
    $form['keys']['#suffix'] = drupal_render($keys_filter_submit);
    $form['items_per_page']['#title'] = t('Items per page: ');
    $items_per_page = $form['items_per_page'];
    unset($form['items_per_page']);
    $form['items_per_page'] = array(
      '#type' => 'item',
      '#title' => t('Options'),
      '#attributes' => array('class' => array('form-item-options')),
      'items_per_page_item' => $items_per_page,
    );
  }
}

/**
 * Alter the date text field form elements being used in the views exposed filters
 *
 * The #id's we're altering include: edit-date-filter-1-min, edit-date-filter-1-max
 */
function library_scenario_date_text_process_alter(&$element, &$form_state, $context) {
  // Let's modify the edit-date-filter-1-min date field element.
  if ($element['#id'] == 'edit-date-filter-1-min') {
    $element['#title'] = t('Start year: ');
    $element['date']['#size'] = 4;
    $element['date']['#attributes']['placeholder'] = 'YYYY';
    unset($element['date']['#description']);
  }
  if ($element['#id'] == 'edit-date-filter-1-max') {
    $element['#title'] = t('to: ');
    $element['date']['#size'] = 4;
    $element['date']['#attributes']['placeholder'] = 'YYYY';
    unset($element['date']['#description']);
  }
  if ($element['#id'] == 'edit-date-filter-min') {
    $element['#title'] = t('Start year: ');
    $element['date']['#size'] = 4;
    $element['date']['#attributes']['placeholder'] = 'YYYY';
    unset($element['date']['#description']);
  }
  if ($element['#id'] == 'edit-date-filter-max') {
    $element['#title'] = t('to: ');
    $element['date']['#size'] = 4;
    $element['date']['#attributes']['placeholder'] = 'YYYY';
    unset($element['date']['#description']);
  }

}

/**
 * Custom function on submission of scenario node form
 */
function _library_scenario_submit($form, &$form_state) {
  // Before we redirect what's the path we're coming from?
  $path = arg();
  if ($path[1] == "add") {
    $redirect = implode('/', $path);
    // redirect to either default or expanded scenario add form
    $form_state['redirect'] = $redirect;
  }
}